{% extends 'recipe_ai/base.html' %}
{% load i18n %}

{% block title %}{{ title }} - {% trans "AI 요리 추천" %}{% endblock %}

{% block content %}
<div class="min-h-screen bg-dark">
    <div class="max-w-5xl mx-auto px-4 py-12">
        <!-- Header -->
        <div class="mb-8">
            <a href="javascript:history.back()" class="inline-flex items-center text-gray-400 hover:text-white transition-colors duration-200 mb-6">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                {% trans "목록으로 돌아가기" %}
            </a>
        </div>

        <!-- Video Info -->
        <div class="bg-gray-medium/30 backdrop-blur-xl border border-gray-600 rounded-2xl overflow-hidden mb-8">
            <div class="p-6 border-b border-gray-600">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h1 class="text-2xl md:text-3xl font-bold text-white mb-3">
                            {{ title }}
                        </h1>
                        <p class="text-gray-400 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            {{ channel }}
                        </p>
                    </div>
                    <!-- 즐겨찾기 버튼 -->
                    <div class="ml-4 flex-shrink-0">
                        <button 
                            id="favoriteBtn" 
                            onclick="toggleFavorite('{{ video_id }}')"
                            class="group flex items-center space-x-2 px-4 py-2 rounded-lg border transition-all duration-200 hover:scale-105"
                            data-is-favorite="{{ is_favorite|yesno:'true,false' }}">
                            <svg class="w-5 h-5 transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                            </svg>
                            <span id="favoriteText" class="text-sm font-medium">{% trans "즐겨찾기" %}</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- YouTube Player -->
            <div class="aspect-video bg-black">
                <iframe
                    width="100%"
                    height="100%"
                    src="https://www.youtube.com/embed/{{ video_id }}"
                    title="YouTube video player"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen
                    class="w-full h-full"
                ></iframe>
            </div>
        </div>

        <!-- AI Summary Section -->
        {% if has_summary %}
        <div class="bg-gray-medium/30 backdrop-blur-xl border border-gray-600 rounded-2xl p-8">
            <div class="flex items-center mb-6">
                <div class="w-12 h-12 bg-gradient-to-r from-orange-500/20 to-orange-600/20 rounded-xl flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </div>
                <div class="flex-1">
                    <div class="flex items-center gap-3">
                        <h2 class="text-2xl font-bold text-white">{% trans "AI 요약 레시피" %}</h2>
                        {% if analysis_method %}
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-orange-500/10 text-orange-400 border border-orange-500/30">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            {{ analysis_method }}
                        </span>
                        {% endif %}
                    </div>
                    <p class="text-gray-400 text-sm mt-1">
                        {% if analysis_method == 'Gemini 영상 분석' %}
                        {% trans "AI가 영상을 직접 시청하고 분석하여 요약했습니다" %}
                        {% else %}
                        {% trans "AI가 영상 자막을 분석하여 요약한 레시피입니다" %}
                        {% endif %}
                    </p>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <!-- Ingredients -->
                <div>
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        {% trans "주요 재료" %}
                    </h3>
                    <ul class="space-y-2">
                        {% for ingredient in ingredients %}
                        <li class="flex items-start">
                            <svg class="w-5 h-5 mr-2 text-orange-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="text-gray-300">{{ ingredient }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Steps -->
                <div>
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                        {% trans "요리 순서" %}
                    </h3>
                    <ol class="space-y-3">
                        {% for step in steps %}
                        <li class="flex items-start">
                            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-orange-500/20 text-orange-400 text-sm font-bold mr-3 flex-shrink-0 mt-0.5">
                                {{ forloop.counter }}
                            </span>
                            <span class="text-gray-300">{{ step }}</span>
                        </li>
                        {% endfor %}
                    </ol>
                </div>
            </div>
        </div>

        {% elif not has_summary %}
        <!-- Analysis Failed -->
        <div class="bg-gray-medium/30 backdrop-blur-xl border border-yellow-600/50 rounded-2xl p-8">
            <div class="flex items-start">
                <div class="w-12 h-12 bg-yellow-500/20 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                    <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-yellow-400 mb-2">{% trans "AI 분석 실패" %}</h3>
                    <p class="text-gray-400 mb-3">{{ error_message }}</p>
                    <div class="bg-gray-dark/50 rounded-lg p-4 border border-gray-600">
                        <p class="text-gray-400 text-sm mb-2">{% trans "시도한 분석 방법:" %}</p>
                        <ul class="text-gray-500 text-sm space-y-1">
                            <li class="flex items-center">
                                <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                {% trans "1차: Gemini 영상 직접 분석" %}
                            </li>
                            <li class="flex items-center">
                                <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                {% trans "2차: 자막 추출 및 분석" %}
                            </li>
                        </ul>
                    </div>
                    <p class="text-gray-500 text-sm mt-3">{% trans "영상을 직접 시청하시거나 다른 레시피를 선택해주세요." %}</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="mt-8 flex flex-col sm:flex-row gap-4">
            <a href="{% url 'recipe_ai:index' %}" class="flex-1 bg-gray-medium border border-gray-600 text-white px-6 py-4 rounded-xl text-center font-medium hover:border-orange-400 transition-all duration-300">
                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                {% trans "다른 요리 찾기" %}
            </a>
            
            <a href="https://www.youtube.com/watch?v={{ video_id }}" target="_blank" class="flex-1 bg-gradient-to-r from-orange-500 to-orange-600 text-white px-6 py-4 rounded-xl text-center font-medium hover:shadow-lg hover:shadow-orange-500/25 transition-all duration-300">
                <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                </svg>
                {% trans "YouTube에서 보기" %}
            </a>
        </div>
    </div>
</div>

<!-- Hidden CSRF Form -->
<form id="csrfForm" style="display: none;">{% csrf_token %}</form>

<script>
// 언어 감지 및 번역 함수
function getTranslation(key) {
    const language = navigator.language || navigator.userLanguage;
    const isEnglish = language.startsWith('en');
    
    const translations = {
        '즐겨찾기': isEnglish ? 'Add to Favorites' : '즐겨찾기',
        '즐겨찾기 취소': isEnglish ? 'Remove from Favorites' : '즐겨찾기 취소',
        '즐겨찾기에 추가되었습니다.': isEnglish ? 'Added to favorites.' : '즐겨찾기에 추가되었습니다.',
        '즐겨찾기에서 제거되었습니다.': isEnglish ? 'Removed from favorites.' : '즐겨찾기에서 제거되었습니다.',
        '오류가 발생했습니다.': isEnglish ? 'An error occurred.' : '오류가 발생했습니다.',
        '즐겨찾기 토글 오류:': isEnglish ? 'Favorite toggle error:' : '즐겨찾기 토글 오류:',
        '즐겨찾기 상태 확인 오류:': isEnglish ? 'Favorite status check error:' : '즐겨찾기 상태 확인 오류:'
    };
    
    return translations[key] || key;
}

// CSRF 토큰 가져오기
function getCSRFToken() {
    const csrfForm = document.getElementById('csrfForm');
    if (csrfForm) {
        const csrfInput = csrfForm.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            return csrfInput.value;
        }
    }
    
    // 쿠키에서 찾기 (폴백)
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    
    return cookieValue || '';
}

// 즐겨찾기 상태 확인
async function checkFavoriteStatus(videoId) {
    try {
        const response = await fetch('{% url "recipe_ai:check_favorite" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ video_id: videoId })
        });

        const data = await response.json();
        updateFavoriteButton(data.is_favorite);
    } catch (error) {
        console.error(getTranslation('즐겨찾기 상태 확인 오류:'), error);
    }
}

// 즐겨찾기 버튼 상태 업데이트
function updateFavoriteButton(isFavorite) {
    const btn = document.getElementById('favoriteBtn');
    const text = document.getElementById('favoriteText');
    const svg = btn.querySelector('svg');
    
    if (isFavorite) {
        // 즐겨찾기 상태
        btn.className = 'group flex items-center space-x-2 px-4 py-2 rounded-lg border border-orange-500/50 bg-orange-500/10 text-orange-400 transition-all duration-200 hover:scale-105 hover:bg-orange-500/20';
        svg.className = 'w-5 h-5 text-orange-400 transition-colors duration-200';
        svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>';
        text.textContent = getTranslation('즐겨찾기 취소');
        btn.dataset.isFavorite = 'true';
    } else {
        // 일반 상태
        btn.className = 'group flex items-center space-x-2 px-4 py-2 rounded-lg border border-gray-600 text-gray-400 transition-all duration-200 hover:scale-105 hover:border-orange-400 hover:text-orange-400';
        svg.className = 'w-5 h-5 transition-colors duration-200';
        svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>';
        text.textContent = getTranslation('즐겨찾기');
        btn.dataset.isFavorite = 'false';
    }
}

// 즐겨찾기 토글
async function toggleFavorite(videoId) {
    const btn = document.getElementById('favoriteBtn');
    const isCurrentlyFavorite = btn.dataset.isFavorite === 'true';
    
    try {
        btn.disabled = true;
        
        // 페이지에서 분석된 데이터 수집
        const recipeData = {
            video_id: videoId,
            title: "{{ title|escapejs }}",
            channel: "{{ channel|escapejs }}",
            thumbnail: "{{ thumbnail|escapejs }}",
            view_count: {{ view_count|default:0 }},
            comment_count: {{ comment_count|default:0 }}
        };
        
        // 레시피 데이터 추가
        {% if has_summary %}
        {% if ingredients_json %}
        recipeData.ingredients = {{ ingredients_json|safe }};
        {% endif %}
        {% if steps_json %}
        recipeData.steps = {{ steps_json|safe }};
        {% endif %}
        {% endif %}
        
        // 댓글 요약 추가
        {% if comment_summary %}
        recipeData.comment_summary = "{{ comment_summary|escapejs }}";
        recipeData.sentiment_rating = {{ sentiment_rating|default:0 }};
        recipeData.difficulty_rating = {{ difficulty_rating|default:0 }};
        {% endif %}
        
        const response = await fetch('{% url "recipe_ai:toggle_favorite" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(recipeData)
        });

        const data = await response.json();

        if (data.status === 'success') {
            updateFavoriteButton(data.is_favorite);
            showToast(data.message);
        } else {
            alert(data.message || getTranslation('오류가 발생했습니다.'));
        }
    } catch (error) {
        console.error(getTranslation('즐겨찾기 토글 오류:'), error);
        alert(getTranslation('오류가 발생했습니다.'));
    } finally {
        btn.disabled = false;
    }
}

// 토스트 메시지 표시
function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full';
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    // 애니메이션으로 표시
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
    }, 100);
    
    // 3초 후 제거
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}

// 페이지 로드 시 즐겨찾기 상태 확인
document.addEventListener('DOMContentLoaded', function() {
    checkFavoriteStatus('{{ video_id }}');
});
</script>
{% endblock %}

