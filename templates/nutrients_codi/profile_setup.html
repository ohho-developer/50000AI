{% extends "nutrients_codi/base.html" %}

{% load i18n %}

{% block title %}{% trans "프로필 설정" %} - {% trans "뉴트리언트코디" %}{% endblock %}

{% block content %}
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Header -->
        <div class="text-center mb-12">
            <div class="inline-flex items-center px-4 py-2 rounded-full bg-gray-medium/50 border border-gray-600 mb-6">
                <span class="text-accent font-mono text-sm">PROFILE SETUP</span>
            </div>
            <h1 class="text-4xl md:text-5xl font-bold mb-6">
                <span class="bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent">
                    {% trans "프로필 설정" %}
                </span>
            </h1>
            <p class="text-xl text-gray-400 max-w-2xl mx-auto">
                {% trans "개인 정보를 입력하면 AI가 맞춤형 영양 가이드를 제공합니다" %}
            </p>
        </div>

        <!-- Profile Form -->
        <div class="bg-gray-medium/30 backdrop-blur-xl border border-gray-600 rounded-2xl p-8">
            <form method="POST" class="space-y-8">
                {% csrf_token %}
                
                <!-- Personal Info Section -->
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-white mb-6">{% trans "개인 정보" %}</h2>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label for="{{ form.gender.id_for_label }}" class="block text-sm font-medium text-gray-300 mb-2">
                                {{ form.gender.label }}
                            </label>
                            {{ form.gender }}
                            {% if form.gender.errors %}
                                <p class="mt-2 text-sm text-red-400">{{ form.gender.errors.0 }}</p>
                            {% endif %}
                        </div>
                        
                        <div>
                            <label for="{{ form.birth_date.id_for_label }}" class="block text-sm font-medium text-gray-300 mb-2">
                                {{ form.birth_date.label }}
                            </label>
                            {{ form.birth_date }}
                            {% if form.birth_date.errors %}
                                <p class="mt-2 text-sm text-red-400">{{ form.birth_date.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label for="{{ form.height.id_for_label }}" class="block text-sm font-medium text-gray-300 mb-2">
                                {{ form.height.label }}
                            </label>
                            {{ form.height }}
                            {% if form.height.errors %}
                                <p class="mt-2 text-sm text-red-400">{{ form.height.errors.0 }}</p>
                            {% endif %}
                            {% if form.height.help_text %}
                                <p class="mt-1 text-sm text-gray-400">{{ form.height.help_text }}</p>
                            {% endif %}
                        </div>
                        
                        <div>
                            <label for="{{ form.weight.id_for_label }}" class="block text-sm font-medium text-gray-300 mb-2">
                                {{ form.weight.label }}
                            </label>
                            {{ form.weight }}
                            {% if form.weight.errors %}
                                <p class="mt-2 text-sm text-red-400">{{ form.weight.errors.0 }}</p>
                            {% endif %}
                            {% if form.weight.help_text %}
                                <p class="mt-1 text-sm text-gray-400">{{ form.weight.help_text }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>


                <!-- Real-time Recommended Intake -->
                <div id="recommended-intake" class="bg-gray-dark/50 rounded-xl p-6 border border-gray-600" style="display: none;">
                    <h3 class="text-lg font-semibold text-white mb-4">{% trans "실시간 권장 섭취량" %}</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div id="calories" class="text-2xl font-bold text-accent">-</div>
                            <div class="text-sm text-gray-400">{% trans "칼로리" %}</div>
                        </div>
                        <div class="text-center">
                            <div id="protein" class="text-2xl font-bold text-accent">-</div>
                            <div class="text-sm text-gray-400">{% trans "단백질" %}</div>
                        </div>
                        <div class="text-center">
                            <div id="carbs" class="text-2xl font-bold text-accent">-</div>
                            <div class="text-sm text-gray-400">{% trans "탄수화물" %}</div>
                        </div>
                        <div class="text-center">
                            <div id="fat" class="text-2xl font-bold text-accent">-</div>
                            <div class="text-sm text-gray-400">{% trans "지방" %}</div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex space-x-4 pt-6">
                    <a 
                        href="{% url 'nutrients_codi:dashboard' %}" 
                        class="flex-1 bg-gray-medium/50 border border-gray-600 text-white py-3 rounded-xl font-medium hover:bg-gray-medium transition-all duration-200 text-center"
                    >
                        {% trans "취소" %}
                    </a>
                    <button 
                        type="submit" 
                        class="flex-1 bg-gradient-to-r from-accent to-accent-dark text-dark py-3 rounded-xl font-semibold hover:shadow-lg hover:shadow-accent/25 transition-all duration-300"
                    >
                        {% trans "프로필 저장" %}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 프로필 페이지 전용 다국어 지원
        window.ProfilePageTranslations = (function() {
            'use strict';
            
            // 브라우저 언어 감지
            const browserLanguage = navigator.language || navigator.userLanguage;
            const isKorean = browserLanguage.startsWith('ko');
        
            // 다국어 지원
            const translations = {
                ko: {
                    calories: '칼로리',
                    protein: '단백질',
                    carbs: '탄수화물',
                    fat: '지방'
                },
                en: {
                    calories: 'Calories',
                    protein: 'Protein',
                    carbs: 'Carbs',
                    fat: 'Fat'
                }
            };
            
            return {
                translations: translations,
                isKorean: isKorean,
                current: translations[isKorean ? 'ko' : 'en']
            };
        })();
        
        // 실시간 권장 섭취량 계산
        window.calculateRecommendedIntake = function() {
            const gender = document.getElementById('{{ form.gender.id_for_label }}').value;
            const birthDate = document.getElementById('{{ form.birth_date.id_for_label }}').value;
            const height = parseFloat(document.getElementById('{{ form.height.id_for_label }}').value) || 0;
            const weight = parseFloat(document.getElementById('{{ form.weight.id_for_label }}').value) || 0;

            // 필수 정보가 모두 입력되었는지 확인
            if (!gender || !birthDate || !height || !weight) {
                document.getElementById('recommended-intake').style.display = 'none';
                return;
            }

            // 나이 계산
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }

            // BMR 계산 (Mifflin-St Jeor Equation)
            let bmr;
            if (gender === 'male') {
                bmr = 10 * weight + 6.25 * height - 5 * age + 5;
            } else {
                bmr = 10 * weight + 6.25 * height - 5 * age - 161;
            }

            // 기본 활동 수준 (보통 활동)으로 설정
            const multiplier = 1.55;
            const dailyCalories = Math.round(bmr * multiplier);

            // 영양소 비율 계산 (균형 잡힌 식단)
            const proteinRatio = 0.25;  // 25%
            const carbRatio = 0.45;     // 45%
            const fatRatio = 0.30;      // 30%

            // 단백질: 4kcal/g, 탄수화물: 4kcal/g, 지방: 9kcal/g
            const dailyProtein = Math.round((dailyCalories * proteinRatio) / 4);
            const dailyCarbs = Math.round((dailyCalories * carbRatio) / 4);
            const dailyFat = Math.round((dailyCalories * fatRatio) / 9);

            // 결과 표시
            document.getElementById('calories').textContent = dailyCalories.toLocaleString();
            document.getElementById('protein').textContent = dailyProtein + 'g';
            document.getElementById('carbs').textContent = dailyCarbs + 'g';
            document.getElementById('fat').textContent = dailyFat + 'g';
            document.getElementById('recommended-intake').style.display = 'block';
            
            // 영양소 라벨 번역 업데이트
            window.updateNutrientLabels();
        }

        // 이벤트 리스너 추가
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = [
                '{{ form.gender.id_for_label }}',
                '{{ form.birth_date.id_for_label }}',
                '{{ form.height.id_for_label }}',
                '{{ form.weight.id_for_label }}'
            ];

            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', calculateRecommendedIntake);
                    element.addEventListener('change', calculateRecommendedIntake);
                }
            });

            // 페이지 로드 시 기존 값이 있다면 계산
            calculateRecommendedIntake();
            
            // 영양소 라벨 번역 적용 (약간의 지연 후)
            setTimeout(window.updateNutrientLabels, 100);
        });
        
        // 영양소 라벨 번역 함수
        window.updateNutrientLabels = function() {
            try {
                // 요소가 존재하는지 확인하고 번역
                const calorieLabel = document.querySelector('#calories')?.nextElementSibling;
                const proteinLabel = document.querySelector('#protein')?.nextElementSibling;
                const carbsLabel = document.querySelector('#carbs')?.nextElementSibling;
                const fatLabel = document.querySelector('#fat')?.nextElementSibling;
                
                if (calorieLabel && !window.ProfilePageTranslations.isKorean) calorieLabel.textContent = window.ProfilePageTranslations.current.calories;
                if (proteinLabel && !window.ProfilePageTranslations.isKorean) proteinLabel.textContent = window.ProfilePageTranslations.current.protein;
                if (carbsLabel && !window.ProfilePageTranslations.isKorean) carbsLabel.textContent = window.ProfilePageTranslations.current.carbs;
                if (fatLabel && !window.ProfilePageTranslations.isKorean) fatLabel.textContent = window.ProfilePageTranslations.current.fat;
            } catch (error) {
                console.log('영양소 라벨 번역 중 오류:', error);
            }
        }
        })();
    </script>
{% endblock %}
