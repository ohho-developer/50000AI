{% extends "account/base.html" %}

{% block head_title %}인증 이메일 전송{% endblock %}

{% block badge_text %}VERIFICATION SENT{% endblock %}

{% block page_title %}인증 이메일을 확인해주세요{% endblock %}

{% block page_description %}이메일 주소 인증을 위해 링크를 보내드렸습니다{% endblock %}

{% block content %}
<div class="text-center space-y-6">
    <div class="w-20 h-20 bg-accent/20 rounded-full flex items-center justify-center mx-auto">
        <svg class="w-10 h-10 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
        </svg>
    </div>

    <div class="bg-gray-dark/30 rounded-xl p-6 border border-gray-700">
        <h3 class="text-lg font-semibold text-white mb-3">이메일을 확인해주세요</h3>
        <p class="text-gray-300 text-sm leading-relaxed">
            계정 인증을 위해 이메일로 인증 링크를 보내드렸습니다.<br>
            받은 편지함을 확인하고 링크를 클릭하여 계정을 활성화해주세요.
        </p>
    </div>

    <div class="bg-gray-dark/20 rounded-xl p-4 border border-gray-700">
        <div class="flex items-start space-x-3">
            <svg class="w-5 h-5 text-accent mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="text-left">
                <p class="text-xs text-gray-400 font-medium mb-1">💡 팁</p>
                <p class="text-xs text-gray-400">
                    이메일이 오지 않았다면 스팸 폴더를 확인해보세요.<br>
                    몇 분 후에도 이메일이 오지 않으면 아래 버튼을 눌러 다시 요청해주세요.
                </p>
            </div>
        </div>
    </div>

    <!-- 메시지 표시 영역 -->
    {% if messages %}
    <div class="space-y-2">
        {% for message in messages %}
        <div class="rounded-xl p-4 border {% if message.tags == 'success' %}bg-green-500/10 border-green-500/50 text-green-300{% elif message.tags == 'error' %}bg-red-500/10 border-red-500/50 text-red-300{% else %}bg-blue-500/10 border-blue-500/50 text-blue-300{% endif %}">
            <div class="flex items-center space-x-2">
                {% if message.tags == 'success' %}
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                {% elif message.tags == 'error' %}
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                {% else %}
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                </svg>
                {% endif %}
                <p class="text-sm font-medium">{{ message }}</p>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- 인증 이메일 재발송 폼 -->
    <form method="POST" action="{% url 'accounts:resend_verification' %}" id="resendForm" class="space-y-4">
        {% csrf_token %}
        
        <!-- 이메일 입력 필드 (로그인 안 된 경우) -->
        <div id="emailInputDiv">
            <label for="email" class="block text-sm font-medium text-gray-300 mb-2">
                이메일 주소 <span class="text-red-400">*</span>
            </label>
            <input 
                type="email" 
                name="email"
                id="emailInput"
                class="w-full bg-gray-dark/50 border border-gray-600 rounded-xl px-4 py-3 text-white placeholder-gray-400 focus:border-accent focus:ring-2 focus:ring-accent/20 focus:outline-none transition-all duration-200"
                placeholder="가입하신 이메일을 입력하세요"
                {% if user.is_authenticated %}value="{{ user.email }}" readonly{% endif %}
            >
            <p class="mt-1 text-xs text-gray-400">가입 시 사용한 이메일 주소를 정확히 입력해주세요.</p>
        </div>
        
        <button 
            type="submit"
            id="resendBtn"
            class="w-full bg-orange-500/20 border border-orange-500/50 text-orange-300 py-3 rounded-xl font-medium hover:bg-orange-500/30 transition-all duration-200 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
        >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <span id="btnText">인증 이메일 다시 보내기</span>
        </button>
    </form>

    <div class="flex space-x-4">
        <a 
            href="{% url 'account_login' %}" 
            class="flex-1 bg-gray-medium/50 border border-gray-600 text-white py-3 rounded-xl font-medium hover:bg-gray-medium transition-all duration-200 text-center"
        >
            로그인 페이지로
        </a>
        <a 
            href="{% url 'home' %}" 
            class="flex-1 bg-gradient-to-r from-accent to-accent-dark text-dark py-3 rounded-xl font-semibold hover:shadow-lg hover:shadow-accent/25 transition-all duration-300 text-center"
        >
            홈으로
        </a>
    </div>

    <script>
        // 재발송 버튼 쿨다운 (3분)
        const resendBtn = document.getElementById('resendBtn');
        const btnText = document.getElementById('btnText');
        const COOLDOWN_TIME = 180; // 3분 (초)
        
        // 로컬 스토리지에서 마지막 발송 시간 확인
        const lastSent = localStorage.getItem('lastEmailSent');
        if (lastSent) {
            const elapsed = Math.floor((Date.now() - parseInt(lastSent)) / 1000);
            if (elapsed < COOLDOWN_TIME) {
                startCooldown(COOLDOWN_TIME - elapsed);
            }
        }
        
        document.getElementById('resendForm').addEventListener('submit', function(e) {
            if (resendBtn.disabled) {
                e.preventDefault();
                return;
            }
            
            // 이메일 입력 확인 (로그인 안 된 경우)
            const emailInput = document.getElementById('emailInput');
            if (emailInput && !emailInput.readOnly && !emailInput.value.trim()) {
                e.preventDefault();
                alert('이메일 주소를 입력해주세요.');
                emailInput.focus();
                return;
            }
            
            // 발송 시간 기록
            localStorage.setItem('lastEmailSent', Date.now().toString());
            
            // 버튼 비활성화 및 쿨다운 시작
            startCooldown(COOLDOWN_TIME);
        });
        
        function startCooldown(seconds) {
            resendBtn.disabled = true;
            let remaining = seconds;
            
            const interval = setInterval(() => {
                const minutes = Math.floor(remaining / 60);
                const secs = remaining % 60;
                btnText.textContent = `다시 보내기 (${minutes}:${secs.toString().padStart(2, '0')})`;
                
                remaining--;
                
                if (remaining < 0) {
                    clearInterval(interval);
                    resendBtn.disabled = false;
                    btnText.textContent = '인증 이메일 다시 보내기';
                }
            }, 1000);
        }
    </script>
</div>
{% endblock %}

{% block footer_links %}
<p class="text-gray-400">
    문제가 계속되면 
    <a href="#" class="text-accent hover:text-accent-dark transition-colors duration-200">
        고객지원
    </a>에 문의해주세요.
</p>
{% endblock %}
